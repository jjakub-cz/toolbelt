# 360° Video Joiner for YouTube

## Overview
PowerShell script that:
- Merges `.mp4`/`.mov` clips from a folder (natural sort).
- Generates a chapters file (`MM:SS Title`).
- Re-encodes to a YouTube-friendly MP4 with **constant frame rate (CFR)** using x264 (CPU) or NVENC (GPU).
- Injects **360° XMP metadata** so YouTube recognizes the video as equirectangular mono.
- Optionally creates a local MKV copy and cleans up temp files.

Outputs are written to a subfolder named `360-2-yt` inside your source directory.

---

## Requirements
- **PowerShell**: Windows PowerShell 5.1+ or PowerShell 7+.
- **ffmpeg & ffprobe**: Must be in `PATH`.
- **ExifTool**: For XMP 360° metadata injection (must be in `PATH`).
- **NVIDIA GPU (optional)**: For NVENC encoding. Use an ffmpeg build compiled with `h264_nvenc`/`hevc_nvenc`.

---

## Usage
```powershell
.\your-script.ps1 -Path "C:\Videos\Project" [-Crf 19] [-TargetFps 0] [-UseGPU $true]
```

### Parameters
- **`-Path`** *(required)*  
  Folder containing input `.mp4`/`.mov` files.

- **`-Crf`** *(default: 19)*  
  Quality target. **Higher = smaller file**.  
  - CPU (x264): uses `-crf`.  
  - GPU (NVENC): uses constant-quality (`-cq`) analog.

- **`-TargetFps`** *(default: auto)*  
  If provided (> 0), forces target CFR. Otherwise, the script detects the **maximum FPS** among inputs, then snaps to the nearest of `59.94, 60, 50, 30, 29.97, 25, 24`, capped at **60**.

- **`-UseGPU`** *(default: `$true`)*  
  When `$true`, uses **NVENC** (HEVC with `-tag:v hvc1`). When `$false`, uses **x264** (CPU).

---

## What the script does (flow)
1. **Discover Inputs**  
   Finds non-empty `.mp4`/`.mov` files in the given folder and sorts them **naturally** (e.g., clip2 before clip10).

2. **Prepare Concat List**  
   Writes a **UTF-8 without BOM** file list that `ffmpeg` can consume safely.

3. **Probe Inputs**  
   Collects durations, FPS, and resolutions via `ffprobe`.

4. **Choose CFR**  
   Picks a robust CFR (either forced via `-TargetFps` or auto from inputs, snapped to common broadcast/YouTube frame rates).

5. **Chapters File**  
   Writes `<timestamp MM:SS> <clip name>` per input into `*_chapters.txt`.

6. **Re-Encode**  
   - **GPU path**:  
     - Pre-pass **lossless remux** to MKV with reset timestamps (stabilizes concat).  
     - Encode with **HEVC NVENC** (`hevc_nvenc`), `-tag:v hvc1`, BT.709 color flags, CFR via `-vf fps=...` and `-fps_mode cfr`, AAC 320 kbps.
   - **CPU path**:  
     - Encode with **x264** (`libx264 -preset slow -crf <Crf>`), BT.709, CFR via `-vf fps=...`, AAC 320 kbps.

   Both paths set `-movflags +faststart` for better streaming.

7. **Inject 360° Metadata**  
   Uses ExifTool to set XMP `GSpherical` tags: equirectangular mono, stitched, etc.

8. **Create Local Copy**  
   Makes a stream-copy **MKV** of the final MP4 for local players like VLC.

9. **Cleanup**  
   Removes the temporary `concat_prep` folder (if used).

---

## Outputs
Inside `...\<YourFolder>\360-2-yt\` you’ll find:
- `YYYYMMDD_HHMMSS_output.mp4` — Final YouTube-ready file (CFR, BT.709, AAC).
- `YYYYMMDD_HHMMSS_chapters.txt` — Chapters in `MM:SS Title` format.
- `YYYYMMDD_HHMMSS_inputs.txt` — ffmpeg concat list (for reference).
- `YYYYMMDD_HHMMSS_output.mkv` — Local playback copy (stream copy of MP4).

---

## Examples

**GPU (default), auto FPS**
```powershell
.\script.ps1 -Path "D:ð\day1"
```

**CPU encode at higher quality**
```powershell
.\script.ps1 -Path "D:ð\day1" -UseGPU $false -Crf 17
```

**Force 29.97 FPS**
```powershell
.\script.ps1 -Path "D:ð\day1" -TargetFps 29.97
```

---

## Notes & Behavior
- FPS is **capped at 60** and snapped to the nearest standard (59.94/60/50/30/29.97/25/24) for smoother playback on YouTube.
- Color info is explicitly set to **BT.709**.
- GPU path encodes with **HEVC** and tags the bitstream as `hvc1` for maximum player compatibility (e.g., Safari).
- The script expects **ffmpeg/ffprobe/exiftool** available in `PATH`.
- Concat list is **UTF-8 without BOM** so ffmpeg reads it correctly even with special characters.

---

## Troubleshooting
- **“NVIDIA NVENC is not available…”**  
  Your ffmpeg build lacks NVENC. Re-run with `-UseGPU $false` or install an ffmpeg build with NVENC support.

- **“ffprobe did not return duration”**  
  The input file might be corrupt or inaccessible. Check permissions and the file itself.

- **“ffmpeg re-encode failed.”**  
  Inspect the console output above this message for the exact ffmpeg error.

- **ExifTool injection failed**  
  Ensure `exiftool` is installed and accessible in `PATH`.

---

## FAQ
**Q: Why HEVC (NVENC) instead of H.264 on GPU?**  
A: For wide 360° frames, HEVC often gives better compression at similar quality. The script also tags the stream as `hvc1` for compatibility.

**Q: Can I keep H.264 when using GPU?**  
A: As written, the GPU path uses HEVC. To force H.264 NVENC you would need to edit the encoder settings in the script.

**Q: How are chapters used on YouTube?**  
A: Upload the MP4, then copy the contents of `*_chapters.txt` into the video description to create chapters automatically.
